<!DOCTYPE html>
<html>
<head>

<title>Finger Track HTML Template</title> 

<style>

#webcamStream {
  visibility: hidden;
  width:320px; 
  height:240px;
}

#interfaceCanvas {
  /* mirror video */
  transform: rotateY(180deg);
  -webkit-transform:rotateY(180deg); /* Safari and Chrome */
  -moz-transform:rotateY(180deg); /* Firefox */
}

</style>

</head>
  
<body>

<video autoplay="true" id="webcamStream"></video>
<canvas id ="interfaceCanvas"></canvas>
<button onclick="init()">Initialize</button>
<button onclick="reset()" disabled="true" id="resetbutton">Reset Tips</button>

<script type="text/javascript" src="cv.js"></script> 
<script type="text/javascript" src="handtracking.js"></script> 
<script type="text/javascript" src="background-subtraction.js"></script> 
<script type="text/javascript" src="finger-tracker.js"></script> 

<script>
  var webcam = document.getElementById("webcamStream");
  
  var interfaceCanvas = document.getElementById("interfaceCanvas");
  var interfaceContext = interfaceCanvas.getContext("2d");
  
  var hiddenCanvas = document.createElement("canvas");
  var hiddenContext = hiddenCanvas.getContext("2d");

  var height, width;
  var background;
  var fingertracker;
  var shortimg = new CV.Image();
  var fingertips = [];

  // states:
  // BEFORE_BG_DELETE = 0;
  // AFTER_BG_DELETE = 1;
  var state = 0;

  window.onload = getVid;

  function getVid() {

    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia 
             || navigator.mozGetUserMedia || navigator.msGetUserMedia 
             || navigator.oGetUserMedia;
    
    if (navigator.getUserMedia) {       
      navigator.getUserMedia({video: true}, handleVideo, videoError);
    }
  }

  function handleVideo(stream) {
    webcam.src = window.URL.createObjectURL(stream);

    width = webcam.clientWidth;
    height = webcam.clientHeight;

    interfaceCanvas.width = width;
    interfaceCanvas.height = height;

    hiddenCanvas.width = width;
    hiddenCanvas.height = height;

    update();

  }
  
  function videoError(e) {
    alert("Could not initialize camera. Yell at Alicia for writting shitty code.");
  }

  function update(){
    requestAnimationFrame(update);

    if (webcam.readyState === webcam.HAVE_ENOUGH_DATA){
      if (state === 0){
        interfaceContext.drawImage(webcam,0,0,width,height);
      }
      else if (state === 1){
        interfaceContext.drawImage(webcam,0,0,width,height);
        shortimg = background.computeImage();
        fingertracker.analyzeImg(shortimg);
        // fingertracker.displayBinImg(shortimg);
        fingertracker.showBounds();
        // fingertracker.showContour(shortimg);
        // fingertracker.showDefects(shortimg);
        // fingertracker.showPalmCenter(shortimg);
        fingertracker.getFingertips(shortimg)
      }
    }
  }

  function init(){
    //captures the background and initializes the fingertracker
    background = new BG(webcam, hiddenContext, width, height);
    fingertracker = new FT(interfaceContext, 90, width, height);
    document.getElementById("resetbutton").disabled = false;
    state = 1;
  }

  function reset(){
    //resets fingertip positions
    fingertracker.initTips();
  }

</script>
</body>
</html>